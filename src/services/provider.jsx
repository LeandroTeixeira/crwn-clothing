import { node } from 'prop-types';
import React, {
  useMemo, useState, useEffect,
} from 'react';
import { GlobalContext, UserContext, ShopContext } from './contexts';
import globalData from './globalData';
import SHOP_DATA from './shopData';
import {
  createUserDocumentFromAuth,
  onAuthStateChangeListener,
  addCollectionAndDocuments,
  getCategoriesAndDocuments,
} from './firebase.utils';
import defaultCartItem from './utils';

// Data for User Context
let [currentUser, setCurrentUser] = [{}, (user) => { currentUser = user; }];

// Data for Global Context
let [dropdownIsOpen, setDropdownIsOpen] = [false, (value) => { dropdownIsOpen = value; }];
let [cartItems, setCartItems] = [[], (items) => { cartItems = items; }];
let [total, setTotal] = [0, (tot) => { total = tot; }];

const toggleDropdown = () => { setDropdownIsOpen(!dropdownIsOpen); };

const addCartItem = (item) => {
  let updatedItem = cartItems.find((e) => e.id === item.id);
  if (updatedItem) {
    updatedItem.qtd += 1;
    setCartItems([...cartItems]);
  } else {
    updatedItem = { ...defaultCartItem, ...item };
    setCartItems([...cartItems, updatedItem]);
  }
  setTotal(total + item.price);
};

const removeCartItem = (item) => {
  const filteredCart = cartItems.filter((e) => e.id !== item.id);
  const newTotal = filteredCart.reduce(
    (acc, current) => acc + current.qtd * current.price,
    0,
  );
  setCartItems(filteredCart);
  setTotal(newTotal);
};

const decreaseCartItem = (item) => {
  const updatedItem = cartItems.find((e) => e.id === item.id);
  if (!updatedItem) return;
  if (updatedItem.qtd === 1) removeCartItem(item);
  else {
    updatedItem.qtd -= 1;
    setTotal(total - item.price);
    setCartItems([...cartItems]);
  }
};

// Data for Shop Context
let [categoriesMap, setCategoriesMap] = [
  [],
  (value) => {
    categoriesMap = value;
  },
];
const setShopContextData = () => ({
  categoriesMap,
  setCategoriesMap,
});

// Definition of the AuthListener and Unsubscribe function
const AuthListener = async (user) => {
  if (user) await createUserDocumentFromAuth(user);
  setCurrentUser(user);
};

const setAuthListener = () => {
  const unsubscribe = onAuthStateChangeListener(AuthListener);
  return unsubscribe;
};

// Provider used, combines all contexts into a single provider.
export default function Provider({ children }) {
  // Setting the auth listener and configuring the unsubscribe function to run at unmount
  useEffect(setAuthListener, []);
  [currentUser, setCurrentUser] = useState(null);

  const setUserContextData = () => ({
    currentUser,
    setCurrentUser,
  });
  const userContextData = useMemo(
    setUserContextData,
    [currentUser, setCurrentUser],
  );

  // Data for Global Context
  [dropdownIsOpen, setDropdownIsOpen] = useState(false);
  [cartItems, setCartItems] = useState([]);
  [total, setTotal] = useState(0);

  const setGlobalContextData = () => ({
    ...globalData,
    dropdownIsOpen,
    setDropdownIsOpen,
    toggleDropdown,
    cartItems,
    setCartItems,
    addCartItem,
    removeCartItem,
    decreaseCartItem,
    total,
    setTotal,
  });
  const globalContextData = useMemo(setGlobalContextData, [
    globalData,
    dropdownIsOpen,
    setDropdownIsOpen,
    toggleDropdown,
    cartItems,
    setCartItems,
    addCartItem,
    removeCartItem,
    decreaseCartItem,
    total,
    setTotal,
  ]);

  // Data for Shop Context
  [categoriesMap, setCategoriesMap] = useState({});
  // useEffect(() => {
  //  addCollectionAndDocuments('categories', SHOP_DATA);
  // }, []);

  useEffect(() => {
    const getCategories = async () => {
      const categoryMap = await getCategoriesAndDocuments('categories');
      // console.log(categoryMap);
      setCategoriesMap(categoryMap);
    };
    getCategories();
  }, []);

  const shopContextData = useMemo(setShopContextData, [
    categoriesMap,
    setCategoriesMap,
  ]);

  return (
    <UserContext.Provider value={userContextData}>
      <ShopContext.Provider value={shopContextData}>
        <GlobalContext.Provider value={globalContextData}>
          {children}
        </GlobalContext.Provider>
      </ShopContext.Provider>
    </UserContext.Provider>
  );
}

Provider.propTypes = {
  children: node,
};
Provider.defaultProps = {
  children: '',
};
